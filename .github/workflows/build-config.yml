name: Build Config from Secrets

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to commit files
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Create config.js from Secrets
        env:
          FORMSPREE_ENDPOINT: ${{ secrets.FORMSPREE_ENDPOINT }}
          GH_PAT: ${{ secrets.GH_PAT }}
          REPO_NAME: ${{ secrets.REPO_NAME }}
          GIT_LABELS: ${{ secrets.GIT_LABELS }}
          CLICKUP_TOKEN: ${{ secrets.CLICKUP_TOKEN }}
          CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
          CLICKUP_STATUS: ${{ secrets.CLICKUP_STATUS }}
          CLICKUP_PRIORITY: ${{ secrets.CLICKUP_PRIORITY }}
        run: |
          # Set defaults if not provided
          GIT_LABELS=${GIT_LABELS:-'["contact-form", "new-lead"]'}
          CLICKUP_STATUS=${CLICKUP_STATUS:-'to do'}
          CLICKUP_PRIORITY=${CLICKUP_PRIORITY:-3}
          
          cat > config.js << EOF
          // Configuration file for SmartProposal Landing Page
          // This file is automatically generated from GitHub Secrets
          // DO NOT edit manually - changes will be overwritten
          
          const CONFIG = {
              // Formspree Configuration
              formspreeEndpoint: "${FORMSPREE_ENDPOINT}",
              
              // GitHub Configuration
              githubToken: "${GH_PAT}",
              githubRepo: "${REPO_NAME}",
              githubLabels: ${GIT_LABELS},
              
              // ClickUp Configuration
              clickupToken: "${CLICKUP_TOKEN}",
              clickupListId: "${CLICKUP_LIST_ID}",
              clickupStatus: "${CLICKUP_STATUS}",
              clickupPriority: ${CLICKUP_PRIORITY}
          };
          EOF

      - name: Commit and push config.js
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add config.js
          git diff --staged --quiet || (git commit -m "Auto-generate config.js from Secrets [skip ci]" && git push)
